rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Match any session document
    match /sessions/{sessionId} {
      
      // Anyone can read a session if they have the ID (the 4-digit code)
      allow read: if true;
      
      // Creating a session: Allow anyone (anonymously authenticated)
      allow create: if request.auth != null;
      
      // Updating a session:
      allow update: if request.auth != null && (
        // Allow updating the status or scenarioId (Teacher/Logic)
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'scenarioId', 'timer', 'round']) ||
        
        // Allow updating a specific player's data block
        // Rule ensures a player can only edit their own UID key inside the 'players' map
        request.resource.data.players.keys().hasAll(resource.data.players.keys()) &&
        request.resource.data.players.get(request.auth.uid, null) != null
      );
    }
  }
}
